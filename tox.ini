[tox]
envlist = py311, py312, lint, security, type-check

[testenv]
deps =
    pytest>=8.0.0
    pytest-asyncio>=0.23.0
    pytest-cov>=4.0.0
    pytest-xdist>=3.5.0
    httpx>=0.27.0
    respx>=0.20.0
    anyio>=4.0.0
    coverage>=7.4.0
    hypothesis>=6.98.0
commands =
    pytest -q --cov=src/litcoach --cov-report=term-missing --cov-report=html:htmlcov --cov-report=xml:coverage.xml --cov-fail-under=85
setenv =
    PYTHONPATH = {toxinidir}/src

[testenv:lint]
deps =
    ruff>=0.1.0
    black>=24.0.0
    isort>=5.13.0
    mypy>=1.8.0
commands =
    ruff check src/litcoach tests
    black --check --diff src/litcoach tests
    isort --check-only --diff src/litcoach tests
    mypy src/litcoach

[testenv:security]
deps =
    bandit>=1.7.0
    detect-secrets>=1.4.0
commands =
    bandit -r src/litcoach -f json -o bandit-report.json || true
    detect-secrets scan --all || true

[testenv:type-check]
deps =
    mypy>=1.8.0
    pyright>=1.1.350
commands =
    mypy src/litcoach
    pyright src/litcoach

[testenv:integration]
deps =
    {[testenv]deps}
    pytest-asyncio>=0.23.0
commands =
    pytest -q -m integration --cov=src/litcoach --cov-report=xml --cov-append

[testenv:e2e]
deps =
    {[testenv]deps}
    pytest-asyncio>=0.23.0
commands =
    pytest -q -m e2e --cov=src/litcoach --cov-report=xml --cov-append

[testenv:property]
deps =
    {[testenv]deps}
    hypothesis>=6.98.0
commands =
    pytest -q -m property --cov=src/litcoach --cov-report=xml --cov-append

[testenv:performance]
deps =
    locust>=2.20.0
    pytest-benchmark>=4.0.0
commands =
    pytest -q tests/test_performance.py --benchmark-only

[testenv:coverage]
deps =
    coverage>=7.4.0
commands =
    coverage combine
    coverage html -d htmlcov
    coverage xml -o coverage.xml
    coverage report --fail-under=85

[testenv:clean]
deps =
commands =
    find . -type d -name __pycache__ -delete
    find . -type d -name .pytest_cache -delete
    find . -type d -name .mypy_cache -delete
    find . -type d -name .ruff_cache -delete
    find . -name "*.pyc" -delete
    find . -name "*.pyo" -delete
    rm -rf .coverage htmlcov coverage.xml bandit-report.json